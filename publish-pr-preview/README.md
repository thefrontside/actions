# Publish PR Preview
`publish-pr-preview` will publish packages with the changes proposed in the pull request so that developers do not need for it to be reviewed, approved, and merged. Once the preview packages are published the action generates a comment with instructions on how to access the packages.

## Monorepo Support
This action now supports monorepos and will do all of the heavy lifting without burdening the developer with any complicated setup process. The action automatically detects which files have been modified and will only publish packages that have changes proposed as to not use up unnecessary resources.

## Package Registry
The registry to which the packages will be published is determined by the `publishConfig` settings in the `package.json` file. If you wish to publish to `Github Package Registry`, please include the following in your `package.json` file for each of the packages in your repository:
```
{
  "publishConfig": {
    "registry": "https://npm.pkg.github.com/"
  }
}
```
Without this configuration, the action will default to publishing to `npmjs` and will require `NPM_AUTH_TOKEN` to be passed in through the workflow.

This is not to be mistaken with the `SCOPES` argument which is for retrieving packages from private organizations and does not have anything to do with publishing.

## Requirements
- Meant to only run on a pull request
- Pass in `GITHUB_TOKEN` (but see `Private Dependencies` below)
- Optional: Specify `IGNORE` argument for directory of packages you don't want published for monorepos
  - Directories specified in `.gitignore` won't be processed to begin with so for example if you don't want to include `./node_modules` and it's already included in your `.gitignore` file then there's no need to add it to the `IGNORE` arg in the workflow
  - Packages that have sub-packages within its directory will intentionally skip during the publish process.

### Private Dependencies
- If your project has private package dependencies, you must specify so through the `scopes` argument with the syntax `organization@registry`. See example below in `usage`.
- To access private packages on `Github Package Registry`, you must generate a personal access token, set it as a secret variable from your repository settings, and pass it in as `GITHUB_TOKEN` in the workflow.
  - The reason why this is necessary is because the `GITHUB_TOKEN` generated by the action is only scoped to the repository from which you are running the action. Personal access tokens will share the same functionality except now Github recognizes your level of access to other projects outside of that one repository.
- Currenty this action only recognizes `gpr` and `npm` for package registries. If your project requires other registries, feel free to let us know and we will add those.

### Publishing to NPMjs
- In order to use `npmjs` as the package registry, pass in the token in the workflow as `NPM_AUTH_TOKEN`.
- :warning: If you're publishing to `gpr` but have private npm packages as dependencies you must still add `NPM_AUTH_TOKEN`.

### Custom Script
- Passing in an argument for `NPM_PUBLISH` will run that command instead of `npm publish`.
  - :warning: However, if you provide this argument, it will run that script to publish for every package (if you're running this action on a monorepo).

## Usage
```yaml
jobs:
  job_name:
    name: Job Name
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Publish PR Preview
      uses: thefrontside/actions/publish-pr-preview@master
      with:
        NPM_PUBLISH: npm run my-script
        IGNORE: folder/example_package folder/example_package2
        SCOPES: minkimcello@npm thefrontisde@gpr
      env:
        GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
```
